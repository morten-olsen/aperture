# Client

The API client lives in `apps/expo/src/client/` and handles all communication with the GLaDOS API server.

## AgenticClient

`client.ts` — the main client class. Instantiated once in the root layout and provided via React context.

```ts
const client = new AgenticClient({
  baseUrl: 'http://localhost:4000/api',
  userId: 'admin',
  createSseConnection,  // platform-specific SSE factory
});
```

### Methods

| Method | Description |
|---|---|
| `invokeTool<T>(toolId, input)` | Call a tool and get a typed result. Generic over `ToolId`. |
| `listTools()` | List all available tools with their JSON schemas. |
| `getCapabilities()` | List registered plugins. |
| `sendPrompt(params)` | Start a prompt (returns `promptId`, results stream via SSE). |
| `approveToolCall(promptId, toolCallId)` | Approve a tool call that requires human approval. |
| `rejectToolCall(promptId, toolCallId, reason?)` | Reject a pending tool call. |
| `connect()` / `disconnect()` | Manage the SSE event stream connection. |

### Authentication

All requests include an `X-User-Id` header. There is no token-based auth — the user ID is configured in the Settings screen and persisted to `AsyncStorage`.

### Tool Invocation Typing

`invokeTool` is generic over the `ToolId` union type generated by the codegen script:

```ts
// Input and output are fully typed — ToolInput<'conversation.get'> = { id: string }
const result = await client.invokeTool('conversation.get', { id: 'abc' });
result.result.prompts; // typed as unknown[]
```

See [Codegen](./codegen.md) for how these types are generated.

## SSE Event Stream

The client uses Server-Sent Events to receive real-time updates from prompts.

### Architecture

```
client.sse.ts          Shared types (CreateSseConnection, SseConnection)
client.sse.web.ts      Web implementation (fetch + EventSourceParserStream)
client.sse.native.ts   React Native implementation (react-native-sse)
client.events.ts       EventStream class — routing, reconnection, subscriptions
```

The SSE transport is abstracted via a `CreateSseConnection` factory function. Expo resolves `.web.ts` vs `.native.ts` at build time based on the target platform.

### EventStream

`EventStream` manages the SSE connection with automatic reconnection (exponential backoff, 1s to 30s). It provides two subscription patterns:

- **Global** — `subscribeGlobal(handler)` receives all events
- **Per-prompt** — `subscribeToPrompt(promptId, handler)` receives events for a specific prompt (matched via `promptId` field in the event data)

### Event Types

Events are dispatched by the server when a prompt is running:

| Event | Payload | Description |
|---|---|---|
| `prompt.output` | `{ promptId, type, content?, ... }` | New output entry (text or tool call) |
| `prompt.approval` | `{ promptId, toolCallId, toolName, input, reason }` | Tool call needs human approval |
| `prompt.completed` | `{ promptId, usage }` | Prompt finished |
| `prompt.error` | `{ promptId, error }` | Prompt failed |
